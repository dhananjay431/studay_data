<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous" />

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js"
        integrity="sha384-7qAoOXltbVP82dhxHAUje59V5r2YsVfBafyUDxEdApLPmcdhBPg1DKg1ERo0BZlK"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ramda/0.31.3/ramda.min.js"
        integrity="sha512-zJ3UuOCYC78i+G+5PXrgOOnC/BZ2CTlW6uOHnULd1oQPRSU1kxs/ckFlbRLWA3I/CPZjIyBtbh/z8/y0ZIPTNA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.0.0-beta/Chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        #myChart {
            width: 100%important;
            height: 100vh !important;
        }

        #chart {
            width: 100% !important;
            height: 100vh !important;
        }
    </style>
    <title>Document</title>

</head>

<body>
    <div class="row">
        <div class="col-4">
            <select id="symbol" class="form-control form-control-sm">

            </select>
        </div>
        <div class="col-4">
            <select id="db-number" class="form-control form-control-sm">
                <option>10</option>
                <option>50</option>
                <option>100</option>
                <option>200</option>
                <option>400</option>
                <option>800</option>
                <option></option>
            </select>
        </div>
        <div class="col-4">
            <button class="btn btn-sm btn-primary"
                onclick="downloadJsonFile(dtx, new Date().getTime() + '.json')">Download
                JSON</button>
        </div>
        <div class="col-12">
            <textarea class="form-control" id="db-data" rows="3"></textarea>

        </div>
        <div class="col-12" id="dny-myChart">
            <canvas id="myChart"></canvas>
        </div>
        <div class="col-12" id="dny-chart">
            <div id="chart"></div>
        </div>
    </div>

    <script>
        var dt = [];
        function downloadJsonFile(data, filename) {

            let csv = data.map(d => {
                let dd = d.data.reduce((a, b, i) => {
                    a['z_' + i] = b;
                    return a;
                }, d);
                delete dd.data;
                return dd;
            })
            const jsonString = JSON.stringify(csv, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a); // Append to body to ensure click works in all browsers
            a.click();
            document.body.removeChild(a); // Clean up the element
            URL.revokeObjectURL(url);
        }

        function toCreateCDLDataArr(fil) {
            return fil[0]["data"].map((d, i) => {
                // o h l c
                let rn1 =
                    1 +
                    [-5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5][getRndInteger(0, 11)] / 100;
                let rn2 =
                    1 +
                    [-5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5][getRndInteger(0, 11)] / 100;
                let rn3 =
                    1 +
                    [-5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5][getRndInteger(0, 11)] / 100;

                return {
                    x: new Date().getTime() + i,
                    y: [d * rn1, d * rn2, d * rn3, d],
                };
            });
        }
        var dtx = [];
        document.getElementById("db-number").addEventListener("change", (e) => {
            dtx = getDataFtromId(JSON.parse(document.getElementById("db-data").value).data);

            select = document.getElementById('symbol');
            select.innerHTML = '';
            dtx.forEach(d => {
                let op = document.createElement('option');
                op.value = d.symbol;
                op.innerText = d.symbol;
                select.appendChild(op);
            })
            show(dtx);
        })
        document.getElementById("db-data").addEventListener("change", (e) => {
            dtx = getDataFtromId(JSON.parse(e.target.value).data);

            select = document.getElementById('symbol');
            select.innerHTML = '';
            dtx.forEach(d => {
                let op = document.createElement('option');
                op.value = d.symbol;
                op.innerText = d.symbol;
                select.appendChild(op);
            })
            show(dtx);

        })
        function getDataFtromId(txt) {

            let dt = R.pipe(
                R.filter((d) => d.priority == 0),
                R.map((d) => {

                    return {
                        symbol: d.symbol,
                        lastPrice: d.lastPrice,
                        industry: d.meta.industry,
                    };
                })
            )(txt);

            for (let d = 0; d < dt.length; d++) {
                let cmm = R.groupBy((a) => a["industry"])(dt);
                let x = R.pipe(
                    R.keys,
                    R.reduce((a, b) => {
                        a[b] = [-3, -2, -1, 0, 1, 2, 3][getRndInteger(0, 7)];
                        return a;
                    }, {})
                );
                let indexPF = x(cmm);
                dt[d]["data"] = getArr(dt[d], indexPF);
            }
            return dt;
        }

        document.getElementById("symbol").addEventListener("change", (e) => {
            let sym = e.target.value;


            let fil = dtx.filter((d) => d["symbol"] === sym);
            document.getElementById("dny-myChart").innerHTML =
                '<canvas id="myChart"></canvas>';
            document.getElementById("dny-chart").innerHTML =
                ' <div id="chart"></div>';
            drawChart(fil);

            generateCandelChart(toCreateCDLDataArr(fil));
        });
        function getRndInteger(min, max) {
            return Math.floor(Math.random() * (max - min)) + min;
        }

        function getArr(n, indexPF) {
            let arr = [];
            let label = [];
            while (arr.length < Number(document.getElementById("db-number").value || 100)) {
                let rn = [-5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5][getRndInteger(0, 11)];
                let ans = Number(Number(n["lastPrice"] * (1 + rn / 100)).toFixed(2));

                n["lastPrice"] = ans;
                arr.push(n["lastPrice"]);
                if (n["lastPrice"] < 1) {
                    break;
                }
            }
            return arr;
        }

        //randome_data_with_chart.html

        function drawChart(arr) {
            var originalLineDraw = Chart.controllers.line.prototype.draw;
            Chart.helpers.extend(Chart.controllers.line.prototype, {
                draw: function () {
                    originalLineDraw.apply(this, arguments);
                    var chart = this.chart;
                    var ctx = chart.chart.ctx;
                    var index = chart.config.data.lineAtIndex;
                    if (index) {
                        var xaxis = chart.scales["x-axis-0"];
                        var yaxis = chart.scales["y-axis-0"];
                        ctx.save();
                        ctx.beginPath();
                        ctx.moveTo(xaxis.getPixelForValue(undefined, index), yaxis.top);
                        // ctx.strokeStyle = "#ff0000";
                        ctx.lineTo(
                            xaxis.getPixelForValue(undefined, index),
                            yaxis.bottom
                        );
                        ctx.stroke();
                        ctx.restore();
                    }
                },
            });

            var config = {
                type: "line",
                data: {
                    //labels: arr.map((_, i) => i + 1),
                    labels: arr[0]["data"],

                    datasets: [
                        {
                            label: arr[0]["symbol"] + " - " + arr[0]["industry"],
                            data: arr[0]["data"],
                            fill: false,
                            borderColor: "blue",
                            backgroundColor: "blue",
                            borderWidth: 1,
                            // pointStyle: "rectRot",
                            pointRadius: 0,
                            // pointBorderColor: "rgb(0, 0, 0)",
                        },
                    ],
                    lineAtIndex: 1,
                },
            };

            var ctx = document.getElementById("myChart").getContext("2d");
            new Chart(ctx, config);
        }

        function generateCandelChart(data) {
            const options = {
                series: [
                    {
                        data: data,
                    },
                ],
                chart: {
                    type: "candlestick",
                    height: 450,
                },
                xaxis: {
                    type: "datetime",
                    // min: data.at(-1).x,
                    // max: data[0].x,
                    min: data[0].x,
                    max: data.at(-1).x,
                },
            };

            const chart = new ApexCharts(
                document.querySelector("#chart"),
                options
            );
            chart.render();
        }

        function show(dt) {

            drawChart([dt[0]]);
            console.log(dt, R.groupBy((a) => a["industry"])(dt));

            let cdl = dt[0]["data"].map((d, i) => {
                // o h l c
                let rn1 =
                    1 +
                    [-10, -9, -8, -7, -6, -5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10][getRndInteger(0, 21)] / 100;
                let rn2 =
                    1 +
                    [-10, -9, -8, -7, -6, -5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10][getRndInteger(0, 21)] / 100;
                let rn3 =
                    1 +
                    [-10, -9, -8, -7, -6, -5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10][getRndInteger(0, 21)] / 100;

                return {
                    x: new Date().getTime() + i,
                    y: [d * rn1, d * rn2, d * rn3, d],
                };
            });
            console.log(cdl);
            generateCandelChart(cdl);
        }
        //start chart

        // downloadJsonFile(dt, new Date().getTime() + ".json");
    </script>
</body>

</html>
